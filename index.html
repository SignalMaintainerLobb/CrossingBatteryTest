<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Battery Tester</title>
  <style>
    /* Battery Housing Container */
    #battery-popup {
      width: 300px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
      border: 2px solid #333;
      border-radius: 10px;
      font-family: sans-serif;

    }

    /* Battery Box */
    .battery-box {
      position: relative;
      width: 100%;
      height: 120px;
      background-color: #c0c0c0;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* Terminals */
    .terminal {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: #333;
      border-radius: 50%;
    }

    .positive {
      background-color: red;
    }

    .negative {
      background-color: black;
    }

    /* Positioning Terminals */
    #positive1 { top: 10px; left: -300px; }
    #positive2 {
     top: 40px;
     left: -301px;
     background-color: gold;
     border: 2px solid #cfa02c; /* Give it a little metallic definition */
     cursor: pointer;           /* Suggest interactivity */
}
    #positive3 { top: 70px; left: -300px; }

    #negative1 { bottom: 80px; left: -100px; }
    #negative2 { bottom: 50px; left: -100px; }

 /* Connection Lines */
    .connection-line {
      position: absolute;
      height: 2px;
      background-color: #000;
    }

#neg-connection {
  left: -91px;              /* Move it toward the left */
  top: 20px;               /* Set its vertical position */
  width: 2px;              /* Skinny width since it's now vertical */
  height: 30px;           /* Tall height to span vertically */
  background-color: black; /* Line color */
}


#pos-connection {
  left: -291px;              /* Move it toward the left */
  top: 20px;               /* Set its vertical position */
  width: 2px;              /* Skinny width since it's now vertical */
  height: 60px;           /* Tall height to span vertically */
  background-color: red; /* Line color */
}


    /* Measurements Display */
    .measurements {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 10px;
    }

    .measurement {
      font-weight: bold;
      background: #fff;
      padding: 5px;
      border: 1px solid #aaa;
      border-radius: 5px;
    }


    }


    }
#testSwitchBtn {
  padding: 10px;
  background-color: #ffa500;
  border: none;
  border-radius: 5px;
  color: #000;
  font-weight: bold;
  margin-top: 10px;
  cursor: pointer;
  }

#testSwitchBtn:hover {
  background-color: #cc8400;
  }

#crossingStatus {
  margin-top: 10px;
  font-weight: bold;
  }
  </style>
</head>
<body>

  <!-- Battery Tester Popup Interface -->
  <div id="battery-popup">

    <!-- Battery Housing -->
    <div class="battery-box">

      <!-- Terminals -->
      <div class="terminal positive" id="positive1"></div>
      <div class="terminal positive" id="positive2"></div>
      <div class="terminal positive" id="positive3"></div>

      <div class="terminal negative" id="negative1"></div>
      <div class="terminal negative" id="negative2"></div>

 <!-- Connection Lines -->
      <div class="connection-line" id="neg-connection"></div>
      <div class="connection-line" id="pos-connection"></div>
    </div>


    <!-- Measurement Display -->
    <div class="measurements">
      <div class="measurement" id="volts-display">Volts: --</div>
      <div class="measurement" id="amps-display">Amps: --</div>
    </div>


<button id="measureVoltsBtn">Measure Volts</button>

<button id="measureAmpsBtn">Measure Amps</button><br>

<br>

<div id="terminalSelection">
  <label><input type="radio" name="redTerminal" value="POS1" checked /> POS1</label>
  <label><input type="radio" name="redTerminal" value="POS2" /> POS2</label>
  <label><input type="radio" name="redTerminal" value="POS3" /> POS3</label>
</div>
  
<button id="clipRedBtn">Clip Red Lead</button>
<div id="clipStatus">Red lead not clipped yet.</div>

<br>

<div id="blackTerminalSelection">
  <label><input type="radio" name="blackTerminal" value="POS1" checked /> POS1</label>
  <label><input type="radio" name="blackTerminal" value="POS2" /> POS2</label>
  <label><input type="radio" name="blackTerminal" value="POS3" /> POS3</label>
</div>

<button id="clipBlackBtn">Clip Black Lead</button>
<div id="blackClipStatus">Black lead not clipped yet.</div>

<br>

<button id="testSwitchBtn">Throw Crossing Test Switch</button>
<div id="crossingStatus">Crossing Status: GATE NORMAL </div>

<br>


<button id="goldNutBtn">Open Test Nut</button>
<div id="nutStatus">Nut is closed.</div>

<br>

<button id="unclipLeadsBtn">Unclip Leads</button>
<button id="resetFuseBtn">Reset Meter Fuse</button>
<div id="fuseIndicator" style="display:none; color:red;">Fuse Blown</div>

<br>

<div id="meter-override-indicator" style="display: none; color: orange; font-weight: bold;">
  Meter Override Active
</div>


  </div>


<script>

  let nutClosed = true;
let redClip = null;
let blackClip = null;
let clipStage = 0;
let testMode = "amps";
let fuseBlown = false;
let testSwitchPressed = false;
let overrideComplete = false;

function calculateAmps() {
  if (fuseBlown) return "-- (Fuse Blown)";
  if (redClip === blackClip) return "-- (Leads on same terminal)";
  if (!redClip || !blackClip) return "--";

  const meterIn = redClip === "POS1" && blackClip === "POS3";
  const nutOpen = !nutClosed;

  if (testSwitchPressed && meterIn && nutOpen)
    return overrideComplete ? "7.0A" : "1.0A";
  if (testSwitchPressed && meterIn && nutClosed) return "0.0A";
  if (meterIn && nutOpen) return overrideComplete ? "5.0A" : "20.0A";
  if (meterIn && nutClosed) return "0.0A";
  if (nutOpen) return "5.0A";
  return "0.0A";
}

function calculateCrossingStatus() {
  const meterIn = redClip === "POS1" && blackClip === "POS3";
  const nutOpen = !nutClosed;

  if (meterIn && testSwitchPressed) return "GATE DOWN METER IN";
  if (meterIn && !testSwitchPressed) return "GATE UP METER IN";
  if (nutOpen || testSwitchPressed) return "GATE DOWN";
  return "GATE NORMAL";
}


  // Nut toggle + crossing status
  
  console.log("Nut toggle triggered. New state:", nutClosed);

  document.getElementById("goldNutBtn").addEventListener("click", () => {



  // Flip nut state

  nutClosed = !nutClosed;
  document.getElementById("goldNutBtn").textContent = nutClosed ? "Open Test Nut" : "Close Test Nut";
  updateCrossingStatus();

if (testSwitchPressed && meterIn && testMode === "amps") {
  if (!nutClosed) {
   updateDisplay();
  } else {
    updateDisplay();
  }
}


 // Recalculate amps if in amps mode

  if (testMode === "amps" && redClip && blackClip) {
  if (redClip === blackClip) {
    updateDisplay();
    
    return;
  }
  
  }


  // Update status display

   const statusText = nutClosed ? "Nut is closed." : "Nut is open.";
   document.getElementById("nutStatus").textContent = statusText;

  // Update volts display if in voltage mode
  if (testMode === "voltage" && redClip) {
  let volts = "0V";
  if (redClip === "POS1") {
    volts = "12V";
  } else if ((redClip === "POS2" || redClip === "POS3") && nutClosed) {
    volts = "12V";
  }
  document.getElementById("volts-display").textContent = `Volts (${redClip}): ${volts}`;
  }


  // Change crossing logic (just for visual realism)

  


  // Recalculate amps if in amps mode and both leads are clipped

  if (testMode === "amps" && redClip && blackClip) {
  let amps = "--";
  const isNutOpen = !nutClosed;
  const meterInCircuit = redClip && blackClip;


  if (isNutOpen && meterInCircuit) {
    amps = "5.0A";
    gateState = "GATE NORMAL";
  } else if (nutClosed && meterInCircuit) {
    amps = "0.0A";
    gateState = "GATE NORMAL";
  } else {
    amps = "--";
    gateState = "METER OUT";
  }

  updateDisplay();
  
  }

  // Update POS2 and POS3 visibility based on nut state

  const pos2 = document.getElementById("positive2");
  const pos3 = document.getElementById("positive3");

  if (!nutClosed) {
  // Nut is open – dim POS2 
  pos2.style.opacity = "0.3";
  

  // Clear red lead if clipped to inactive terminal

  if (redClip === "POS2" || redClip === "POS3") {
    redClip = null;
    clipStage = 0;
    document.getElementById("clipStatus").textContent = "Red lead needs re-clipping.";
    document.getElementById("volts-display").textContent = "Volts: --";
    updateDisplay();
    

  }
  } else {

  // Nut is closed – restore full visibility

  pos2.style.opacity = "1";
  pos3.style.opacity = "1";
  }

if (
  testSwitchPressed &&
  testMode === "amps" &&
  redClip === "POS1" &&
  blackClip === "POS3"
) {
  if (nutClosed) {
    updateDisplay();
  } else {
    const crossingText = document.getElementById("crossingStatus").textContent;
    if (crossingText.includes("GATE NORMAL")) {
      updateDisplay();
    }
  }
}
  });

function updateDisplay() {
  document.getElementById("amps-display").textContent = `Amps: ${calculateAmps()}`;
  document.getElementById("crossingStatus").textContent = `Crossing Status: ${calculateCrossingStatus()}`;

  
}



  // Step 1: Clip Red Lead

    document.getElementById("clipRedBtn").addEventListener("click", () => {
  const selected = document.querySelector('input[name="redTerminal"]:checked');
  redClip = selected ? selected.value : null;

  clipStage = 1;
  document.getElementById("clipStatus").textContent = `Red lead clipped to ${redClip}.`;
  updateDisplay();

 

  

  if (testMode === "voltage") {
    blackClip = "NEG1";
    document.getElementById("blackClipStatus").textContent = "Black lead automatically placed on NEG1 (voltage test)";
    document.getElementById("blackTerminalSelection").style.display = "none";

    // Voltage preview logic if needed

    let volts = "0V";
    const activeWhenNutOpen = redClip === "POS1";
    if (nutClosed || activeWhenNutOpen) {
      volts = "12V";
    }
    document.getElementById("volts-display").textContent = `Volts: ${volts}`;
    updateDisplay();
    } else if (testMode === "amps") {

    // For amps test, wait until black lead is manually clipped to POS3

    document.getElementById("blackClipStatus").textContent = "Ready to clip black lead for current test.";
    document.getElementById("blackTerminalSelection").style.display = "block";
    document.getElementById("volts-display").textContent = "Volts: --";
    updateDisplay();


  }
  if (testMode === "amps") {
  performAmpsMeasurement();
  }
  });

  // Step 2: Clip Black Lead

  document.getElementById("clipBlackBtn").addEventListener("click", () => {
  const selected = document.querySelector('input[name="blackTerminal"]:checked');
  blackClip = selected ? selected.value : null;

  if (clipStage !== 1) {
    document.getElementById("blackClipStatus").textContent = "Please clip red lead first.";
    return;
  }

  clipStage = 2;
  document.getElementById("blackClipStatus").textContent = `Black lead clipped to ${blackClip}.`;

  // Trigger amps read immediately if in amps mode
  function performAmpsMeasurement() {
  if (testMode !== "amps" || !redClip || !blackClip) return;

  let amps = "--";
  let gateState = "METER OUT";
  const isNutOpen = !nutClosed;

  if (redClip === blackClip) {
    amps = "--";
    gateState = "Invalid lead configuration";
  } else if (
    (redClip === "POS2" && blackClip === "POS3") ||
    (redClip === "POS3" && blackClip === "POS2")
  ) {
    amps = "0.0A";
    gateState = isNutOpen ? "GATE DOWN" : "GATE NORMAL";
  } else if (
    (redClip === "POS1" && blackClip === "POS3") ||
    (redClip === "POS3" && blackClip === "POS1")
  ) {
    if (isNutOpen) {
      amps = "20.0A";
      gateState = "GATE UP METER IN";
      updateDisplay();
     
      setTimeout(() => {
        updateDisplay();
        updateCrossingStatus();
      }, 5000);
      return;
    } else {
      amps = "0.0A";
      gateState = "GATE NORMAL";
    }
  } else {
    amps = isNutOpen ? "5.0A" : "0.0A";
    gateState = isNutOpen ? "GATE DOWN" : "GATE NORMAL";
  }

function updateMeterReadings() {
  if (testMode === "amps") {
    if (redClip === "POS1" && blackClip === "POS3" && nutClosed) {
      updateDisplay();

      setTimeout(() => {
        updateDisplay();
        updateCrossingStatus(); // Optional: recheck gate status after surge
      }, 5000);
    } else {
      updateDisplay();
    }
  }
}

  updateDisplay();
  
  }

  if (testMode === "amps") {
  performAmpsMeasurement();
  }



  });

  // Step 3: Measure Voltage

     document.getElementById("measureVoltsBtn").addEventListener("click", () => {
     testMode = "voltage";

updateDisplay();


  // Check if we were previously in amps mode and clipped across POS1 and POS3 with nut open

  if (
  redClip === "POS1" &&
  blackClip === "POS3" &&
  !nutClosed
  ) {
  updateDisplay();
  }

    // Unclip leads and update crossing status based on nut state

    redClip = null;
    blackClip = null;
    clipStage = 0;
    document.getElementById("clipStatus").textContent = "Red lead not clipped yet.";
    document.getElementById("blackClipStatus").textContent = "Black lead not clipped yet.";
    document.getElementById("volts-display").textContent = "Volts: --";
    updateDisplay();

  if (!nutClosed) {
  updateDisplay();
} else {
  // Check throw test switch state
  const testSwitchBtn = document.getElementById("testSwitchBtn");
  const isTestSwitchPressed = testSwitchBtn.style.backgroundColor === "#d88c00"; // darker = pressed

  if (!nutClosed || testSwitchPressed) {
  updateDisplay();
} else {
  updateDisplay();
}
}

  // Hide black terminal selector and POS1–POS3 (only now!)
  document.getElementById("blackTerminalSelection").style.display = "none";


  // Auto-clip black lead to NEG1

  blackClip = "NEG1";
  document.getElementById("blackClipStatus").textContent = "Black lead automatically placed on NEG1 (voltage test)";

  // Clear amps display

  updateDisplay();

  // Validate red clip presence

  if (!redClip) {
    document.getElementById("volts-display").textContent = "Volts: -- (Red lead not clipped)";
    return;
  }

  let volts = "0V";
  const isNutOpen = !nutClosed;

  if (redClip === "POS1") {
  volts = "12V"; // POS1 always active
  } else if ((redClip === "POS2" || redClip === "POS3") && nutClosed) {
  volts = "12V"; // POS2/POS3 only active when nut is closed
  } else {
  volts = "0V"; // Otherwise, no voltage
  }
  document.getElementById("volts-display").textContent = `Volts: ${volts}`;

overrideComplete = false;
  });


  // Measure amps

  document.getElementById("measureAmpsBtn").addEventListener("click", () => {
  testMode = "amps";


  //fuse blown logic

  const isClippedAcrossPower = (
  redClip &&
  blackClip === "NEG1" &&
  (
    redClip === "POS1" ||
    ((redClip === "POS2" || redClip === "POS3") && nutClosed)
  )
  );

  if (isClippedAcrossPower) {
  fuseBlown = true;
  updateDisplay();
  document.getElementById("fuseIndicator").style.display = "block";
  return;
  }

  // Unclip leads and update crossing status based on nut state

  redClip = null;
  blackClip = null;
  clipStage = 0;
  document.getElementById("clipStatus").textContent = "Red lead not clipped yet.";
  document.getElementById("blackClipStatus").textContent = "Black lead not clipped yet.";
  document.getElementById("volts-display").textContent = "Volts: --";
  updateDisplay();

  // Reset gateState based on nut state alone

   if (!nutClosed) {
  updateDisplay();
} else {
  // Check throw test switch state
  const testSwitchBtn = document.getElementById("testSwitchBtn");
  const isTestSwitchPressed = testSwitchBtn.style.backgroundColor === "#d88c00"; // darker = pressed

  if (!nutClosed || testSwitchPressed) {
  updateDisplay();
} else {
  updateDisplay();
}
}
  // Show terminals and black clip selector again for amp testing

  document.getElementById("positive1").style.display = "block";
  document.getElementById("positive2").style.display = "block";
  document.getElementById("positive3").style.display = "block";
  document.getElementById("blackTerminalSelection").style.display = "block";
  document.getElementById("blackClipStatus").textContent = "";

  });

 //Unclip leads logic

  document.getElementById("unclipLeadsBtn").addEventListener("click", () => {
  redClip = null;
  blackClip = null;
  clipStage = 0;
  document.getElementById("volts-display").textContent = "Volts: --";
  updateDisplay();

updateDisplay();


overrideComplete = false;
  });


  document.getElementById("resetFuseBtn").addEventListener("click", () => {
  fuseBlown = false;
  document.getElementById("fuseIndicator").style.display = "none";
  updateDisplay();
  });

  //Crossing Test Switch

document.getElementById("testSwitchBtn").addEventListener("click", () => {
  const testSwitchBtn = document.getElementById("testSwitchBtn");
  const meterIn = (testMode === "amps" && redClip === "POS1" && blackClip === "POS3");

  testSwitchPressed = !testSwitchPressed;

  if (testSwitchPressed) {
    testSwitchBtn.style.backgroundColor = "#d88c00";
    testSwitchBtn.style.boxShadow = "inset 0 0 5px #000";

    if (!nutClosed && (meterIn || redClip === "POS1")) {
      updateDisplay();
      

      setTimeout(() => {
        updateDisplay();
      }, 5000);

      overrideComplete = true;
    }

    if (overrideComplete && meterIn && !nutClosed) {
      updateDisplay();
      setTimeout(() => {
        updateDisplay();
      }, 5000);
    }

    if (nutClosed && meterIn) {
      updateDisplay();
    }

  } else {
    testSwitchBtn.style.backgroundColor = "#ffa500";
    testSwitchBtn.style.boxShadow = "none";
  }

  updateCrossingStatus();
});
</script>


</body>
</html>
